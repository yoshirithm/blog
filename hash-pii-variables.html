<!-- wp:paragraph -->
<p>With recent changes in measurement, the need for digital marketers to understand what data is being shared with ad tech venders, and more importantly understand how it's being shared its becoming a requirement of the job. Surprisingly Google Tag Manager (GTM) doesn't make passing personally identifiable information in a safe way very easy.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>With cross-site measurement holding on for dear life, passing PII to vendors is needed for them to be able to match the user on your site, with the user in their database. I recently learned how to do this to help with passing the information to <a href="https://developers.facebook.com/docs/marketing-api/conversions-api/">Facebook via their Conversions API (CAPI). </a> </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>This method is done by transforming a dataLayer variable which contains PII, into a Javascript variable which is then a hashed version of that. The process of pushing variables into the dataLayer will not be covered in this article, just the transformation. But there are many articles out there on how to push variables into the dataLayer either via hardcoding or the DOM Element Variable.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3>Adding a Javascript Library</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>First step is to load the Javascript Library of the hash version you want to use. Facebook's CAPI requires SHA256. So we will need to either host this ourselves, or use an established CDN. Its easier to just use an established CDN, so we will use <a href="https://cdnjs.com/libraries/js-sha256">Cloudflare</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Next up you need to make sure that the code can't be tampered with. Afterall we are passing PII from the dataLayer (where its safe) to a Javascript (which isn't so safe). So in order to ensure it can't be tamped with you should use Subresource Integrity (SRI). So enter the SDN javascript library into <a href="https://www.srihash.org/">srihash.org</a>. This should now look liek this:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre id="sriSnippet" class="wp-block-code"><code>&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js" integrity="sha384-2epjwyVj8M4n8AweIsY7SKPSJmqBBBkmksXvkmtYORfxPS1I4NZE/+Ttk/9gCELG" crossorigin="anonymous"&gt;&lt;/script&gt;</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>When using Custom HTML tags, you will need to declare the variables in the code for GTM to understand you, which will look like this:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>&lt;script&gt;
  (function() {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js';  
  script.setAttribute('integrity','sha384-2epjwyVj8M4n8AweIsY7SKPSJmqBBBkmksXvkmtYORfxPS1I4NZE/+Ttk/9gCELG');
  script.setAttribute('crossorigin','anonymous');
  document.getElementsByTagName('head')&#91;0].appendChild(script);
  })();
&lt;/script&gt;</code></pre>
<!-- /wp:code -->

<!-- wp:heading {"level":3} -->
<h3>Transforming Variable to Hash PII</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Last but not least – hash the data. When hashing data, it’s&nbsp;<em>critically important</em>&nbsp;to make sure that the source data is what you expect&nbsp;<em>before</em>&nbsp;hashing. After all, there’s no way to check after it’s been hashed!</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>In my example of hashing an email address in the&nbsp;<code>visitorEmail</code>&nbsp;variable, I want to run some very basic tests on the string to make sure it looks like an email address. In the code block below, you can see the test called out – you should do something similar for other types of data.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>For the final piece – set up a Custom JavaScript variable:</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>Go to the container for your site and select Variables on the left</li><li>Create a new User-Defined Variable</li><li>Select Custom JavaScript from the list of variable types</li><li>In the Custom JavaScript box, enter the following:</li></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>function() {
  // Test email address first
  function emailIsValid (email) {
    return /\S+@\S+\.\S+/.test(email)
  }
  // If email address is valid, hash it
  if (emailIsValid({{visitorEmail}})) {
    var hash = sha256({{visitorEmail}});
    return hash;
  } else {
    return undefined;
  }
}</code></pre>
<!-- /wp:code -->
